---
layout: post
title: Bowling Game kata with Express and Node.js
date: 2014-01-15 09:43:34.000000000 -07:00
categories:
- coding
- professional
tags:
- express
- kata
- node.js
- restify
- supertest
status: publish
type: post
published: true
meta:
  _publicize_twitter_user: "@ChuckDurfee"
  _yoast_wpseo_linkdex: '83'
  _edit_last: '5'
  _syntaxhighlighter_encoded: '1'
  _wpas_done_all: '1'
  _yoast_wpseo_focuskw: express
  _wpas_skip_28796: '1'
  _wpas_skip_4335974: '1'
  _wpas_skip_5821802: '1'
  _jetpack_related_posts_cache: a:1:{s:32:"8f6677c9d6b0f903e98ad32ec61f8deb";a:2:{s:7:"expires";i:1438144535;s:7:"payload";a:3:{i:0;a:1:{s:2:"id";i:1255;}i:1;a:1:{s:2:"id";i:1340;}i:2;a:1:{s:2:"id";i:1150;}}}}
author:
  login: Chuck
  email: chuck@neontapir.com
  display_name: Chuck
  first_name: Chuck
  last_name: Durfee
excerpt: !ruby/object:Hpricot::Doc
  options: {}
---
<p><a href="http://neontapir.com/wp/wp-content/uploads/2014/01/bowling.jpg"><img class="alignright size-medium wp-image-1278" alt="bowling" src="assets/bowling-300x225.jpg" width="300" height="225" /></a></p>
<p>Last time, I talked about the <a href="http://neontapir.com/wp/2014/01/bowling-game-kata-using-node-js/">Bowling Game kata in Node.js</a>, and mentioned that the next step in looking at the <a href="http://www.mean.io/">MEAN stack</a> is <a href="http://expressjs.com/">Express</a>, which is a JavaScript web application framework.</p>
<p>The inclusion of Express means that the game scoring will need to be exposed as a web application. This seems like a good use case for <a href="http://en.wikipedia.org/wiki/Representational_state_transfer">REST</a>. I'm aware that <a href="http://mcavage.me/node-restify/">restify</a> is a better fit for this kind of application, but in keeping with exploration of the MEAN stack, I stuck with Express. In doing some more exploration with Restify, I found that it needs the node development environment to be installed on Windows, which I found off-putting.</p>
<p>For testing, I used <a href="https://github.com/visionmedia/supertestâ€Ž">supertest</a>, which offers nice functionality for testing HTTP servers with a <a href="http://en.wikipedia.org/wiki/Fluent_interface">fluent interface</a>, another programming technique that I'm fond of.</p>
<p>Here's a sample of what the tests look like:</p>
<p>[code lang="js"]<br />
var request = require('supertest'),<br />
    should = require('should');<br />
var game = require('../game.js').app;</p>
<p>var assertScoreEquals = function(expectedScore) {<br />
	request(game).get('/score').expect(200).end(function(err,res) {<br />
	  result = res.body;<br />
	  result.should.have.property('score').eql(expectedScore);<br />
	});<br />
};</p>
<p>var roll = function(pins) {<br />
	request(game).post('/bowl/' + pins).end();<br />
};</p>
<p>var rollMany = function(times, pins) {<br />
	for (var i = 0; i &lt; times; i++) {<br />
		roll(pins);<br />
	}<br />
};</p>
<p>describe('Scoring a bowling game', function() {<br />
  beforeEach(function() {<br />
  	request(game).get('/start').end();<br />
  });</p>
<p>  describe('gutter game', function() {<br />
		it('should return 0', function() {<br />
			rollMany(20,0);<br />
			assertScoreEquals(0);<br />
		});<br />
	});<br />
});<br />
[/code]</p>
<p>The supertest library is what provides the <code>request</code> object. Whenever you call <code>request</code>, you need to execute it with an <code>end()</code> call. I fumbled with this for a few hours. You'll notice that I'm ignoring the error object. I found that when I tried to use it, not only did it clutter up the test code with a <code>done</code> callback:</p>
<p>[code lang="js"]<br />
describe('gutter game', function() {<br />
	it('should return 0', function(done) {<br />
		rollMany(20,0);<br />
		assertScoreEquals(0, done);<br />
	});<br />
});<br />
[/code]</p>
<p>but I also found while running in a <code>mocha -w</code> loop, it caused Mocha to throw exceptions after some time elapsed. I need to dig into this deeper.</p>
<p>Here's the game code, using Express to expose some REST endpoints for knocking down pins and scoring the game:</p>
<p>[code lang="js"]<br />
var express = require('express');<br />
var app = exports.app = express();</p>
<p>app.get('/start', function(req,res) {<br />
  rolls = new Array();<br />
  ball = 0;<br />
});</p>
<p>app.post('/bowl/:pins', function(req,res) {<br />
	rolls[ball] = parseInt(req.params.pins);<br />
  ball++;<br />
});</p>
<p>app.get('/score', function(req,res) {<br />
	var total = 0;<br />
	var ball = 0;<br />
	for(var frame = 0; frame &lt; 10; frame++) {<br />
		// omitted, the scoring algorithm<br />
	}<br />
	res.send(200, {score: total});<br />
});</p>
<p>app.listen(process.env.PORT || 3000);<br />
[/code]</p>
<p>As you can see, while the plumbing is more complicated, it uses the same structure as the pure Node.js solution. That's why I find tools like the Bowling Game kata to be valuable. By solving a problem I've solved many times before, the problem fades into the background and I'm able to focus on learning the language.</p>
<p>The next step is to include <a href="http://angularjs.org">AngularJS</a>.</p>
